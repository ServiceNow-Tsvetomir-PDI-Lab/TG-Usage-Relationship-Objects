<div class="container p-4">
  <h3>Field Usage Finder</h3>

  <div class="form-group">
    <label>Field sys_id (from sys_dictionary)</label>
    <input type="text" class="form-control" ng-model="c.data.fieldSysId" placeholder="Enter field sys_id">
  </div>

  <button class="btn btn-primary mt-3 me-2" ng-click="c.findUsage()">Find Usage</button>
  <button class="btn btn-outline-secondary mt-3 me-2" ng-if="c.data.results && c.data.results.length" ng-click="c.exportToCSV()">
    Export to CSV
  </button>
  <button class="btn btn-danger mt-3" ng-if="c.data.results && c.data.results.length" ng-click="c.clearResults()">Clear</button>

  <!-- Toggle View Switch -->
  <div class="form-check mt-3" ng-if="c.data.results.length">
  <label class="form-check-label me-2" for="toggleViewSwitch">
    {{ c.data.viewMode === 'group' ? 'Grouped View' : 'Table View' }}
  </label>
  <label class="switch">
    <input type="checkbox"
           id="toggleViewSwitch"
           ng-model="c.data.viewModeSwitch"
           ng-change="c.toggleViewFromSwitch()">
    <span class="slider"></span>
  </label>
</div>

  <div ng-if="c.data.error" class="alert alert-danger mt-3">
    {{ c.data.error }}
  </div>
</div>

<!-- Grouped View -->
<div ng-if="c.data.viewMode === 'group' && c.data.results && c.data.results.length > 0">
  <h5>Results for: {{ c.data.fieldName }}</h5>
  <div ng-repeat="(type, group) in c.groupedResults">
    <h5 class="mt-4">{{ type }}</h5>
    <ul class="list-group">
      <li class="list-group-item" ng-repeat="r in group">
        <strong><a href="{{ r.url }}" target="_blank">{{ r.name }}</a></strong><br>
        <small>
          <strong>Table:</strong> {{ r.table }}<br>
          <strong>sys_id:</strong> {{ r.sys_id }}<br>
          <strong>Match Count:</strong> {{ r.matchCount }}<br>
          <strong>Match Row:</strong> {{ r.matchRow }}
        </small>
        <pre class="mt-2">{{ r.match }}</pre>
        <button class="btn btn-sm btn-outline-secondary me-1" ng-click="c.copyText(r.match)">üìã Copy</button>
        <button class="btn btn-sm btn-outline-info me-1" ng-click="c.viewScript(r)">üîç View Full Script</button>
        <a class="btn btn-sm btn-link" href="{{ r.url }}" target="_blank">Open</a>
      </li>
    </ul>
  </div>
</div>

<!-- Table View -->
<div ng-if="c.data.viewMode === 'table' && c.data.results && c.data.results.length > 0" class="mt-4">
  <h5>Results for: {{ c.data.fieldName }}</h5>
  <table class="table table-striped mt-3">
    <thead>
      <tr>
        <th>Type</th>
        <th>Name</th>
        <th>Table</th>
        <th>sys_id</th>
        <th>Match Count</th>
        <th>Match Row</th>
        <th>Match Line(s)</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat="r in c.data.results">
        <td>{{ r.type }}</td>
        <td><a href="{{ r.url }}" target="_blank">{{ r.name }}</a></td>
        <td>{{ r.table }}</td>
        <td>{{ r.sys_id }}</td>
        <td>{{ r.matchCount }}</td>
        <td>{{ r.matchRow }}</td>
        <td>
          <pre>{{ r.match }}</pre>
          <button class="btn btn-sm btn-outline-secondary me-1" ng-click="c.copyText(r.match)">üìã Copy</button>
          <button class="btn btn-sm btn-outline-info" ng-click="c.viewScript(r)">üîç View Full Script</button>
        </td>
        <td><a href="{{ r.url }}" target="_blank">Open</a></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="scriptModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Full Script View</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre>{{ c.fullScript }}</pre>
      </div>
    </div>
  </div>
</div>